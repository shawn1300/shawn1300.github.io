<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32ç¯å¢ƒç›‘æµ‹</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            overflow-x: hidden; /* é˜²æ­¢æ¨ªå‘æ»šåŠ¨ */
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e1e5eb;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        /* ä¼ æ„Ÿå™¨æ•°æ®å¡ç‰‡ */
        .sensors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .sensor-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease;
        }
        
        .sensor-card:hover {
            transform: translateY(-3px);
        }
        
        .sensor-title {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #555;
        }
        
        .sensor-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 1.2rem;
        }
        
        .temp .sensor-icon { background: #ff6b6b; }
        .humi .sensor-icon { background: #4d96ff; }
        .pm25 .sensor-icon { background: #6bcf7f; }
        
        .sensor-value {
            font-size: 2.8rem;
            font-weight: 700;
            color: #2c3e50;
            line-height: 1;
            margin-bottom: 5px;
        }
        
        .sensor-unit {
            font-size: 1.2rem;
            color: #7f8c8d;
            margin-left: 5px;
        }
        
        .sensor-time {
            font-size: 0.9rem;
            color: #95a5a6;
            margin-top: 10px;
        }
        
        .air-quality {
            font-size: 1rem;
            color: #555;
            margin-top: 5px;
        }
        
        /* å›¾è¡¨å®¹å™¨ - å›ºå®šé«˜åº¦ */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            height: 400px; /* å›ºå®šé«˜åº¦é˜²æ­¢æ— é™æ‰©å¼  */
        }
        
        .chart-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .chart-title i {
            margin-right: 10px;
            color: #4d96ff;
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: white;
            border: 2px solid #4d96ff;
            color: #4d96ff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: #4d96ff;
            color: white;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }
        
        .status {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status.connecting { background: #fff3cd; color: #856404; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .update-time {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 8px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .sensors-grid {
                grid-template-columns: 1fr;
            }
            
            .sensor-card {
                padding: 20px;
            }
            
            .sensor-value {
                font-size: 2.4rem;
            }
            
            .chart-container {
                padding: 20px;
                height: 350px;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* ç©ºæ°”è´¨é‡é¢œè‰²æŒ‡ç¤º */
        .quality-excellent { color: #2ecc71; }
        .quality-good { color: #3498db; }
        .quality-moderate { color: #f39c12; }
        .quality-poor { color: #e74c3c; }
        .quality-very-poor { color: #c0392b; }
        .quality-hazardous { color: #8e44ad; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ESP32ç¯å¢ƒç›‘æµ‹ç«™</h1>
        <p class="subtitle">å®æ—¶æ¸©æ¹¿åº¦ä¸ç©ºæ°”è´¨é‡æ•°æ®</p>
    </div>
    
    <div class="sensors-grid">
        <div class="sensor-card temp">
            <div class="sensor-title">
                <div class="sensor-icon">ğŸŒ¡ï¸</div>
                <span>æ¸©åº¦</span>
            </div>
            <div class="sensor-value">--<span class="sensor-unit">Â°C</span></div>
            <div class="sensor-time">æ›´æ–°: <span class="time-temp">--:--</span></div>
        </div>
        
        <div class="sensor-card humi">
            <div class="sensor-title">
                <div class="sensor-icon">ğŸ’§</div>
                <span>æ¹¿åº¦</span>
            </div>
            <div class="sensor-value">--<span class="sensor-unit">%</span></div>
            <div class="sensor-time">æ›´æ–°: <span class="time-humi">--:--</span></div>
        </div>
        
        <div class="sensor-card pm25">
            <div class="sensor-title">
                <div class="sensor-icon">ğŸŒ¬ï¸</div>
                <span>PM2.5</span>
            </div>
            <div class="sensor-value">--<span class="sensor-unit">Î¼g/mÂ³</span></div>
            <div class="air-quality">ç©ºæ°”è´¨é‡: <span class="quality-text">--</span></div>
            <div class="sensor-time">æ›´æ–°: <span class="time-pm25">--:--</span></div>
        </div>
    </div>
    
    <div class="chart-container">
        <div class="chart-title">ğŸ“ˆ å†å²è¶‹åŠ¿</div>
        <canvas id="sensorChart"></canvas>
    </div>
    
    <div class="controls">
        <button class="btn" id="refreshBtn">
            <span>ğŸ”„</span> åˆ·æ–°æ•°æ®
        </button>
        <button class="btn" id="autoRefreshBtn">
            <span>â±ï¸</span> è‡ªåŠ¨åˆ·æ–°: <span id="autoRefreshText">å¼€å¯</span>
        </button>
        <button class="btn" id="clearChartBtn">
            <span>ğŸ—‘ï¸</span> æ¸…ç©ºå›¾è¡¨
        </button>
    </div>
    
    <div class="status-bar">
        <div class="status connecting" id="connectionStatus">æ­£åœ¨è¿æ¥...</div>
        <div class="update-time">
            æœ€åæ›´æ–°: <span id="lastUpdateTime">--</span> | 
            æ•°æ®ç‚¹æ•°: <span id="dataCount">0</span>
        </div>
    </div>

    <script>
        // ==================== é…ç½®éƒ¨åˆ† ====================
        // æ›¿æ¢ä¸ºä½ çš„Supabaseé…ç½®
        const SUPABASE_URL = 'https://wewhpfoxhktpsgogikhu.supabase.co';  // ä¾‹å¦‚: https://abc123.supabase.co
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indld2hwZm94aGt0cHNnb2dpa2h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNDUxMjksImV4cCI6MjA4MTYyMTEyOX0.SSFNbVPaeNOACkwMdhGjz_N0tZQukHQCcuCnt_96fnk';  // ä»¥eyJå¼€å¤´çš„å¯†é’¥
        const TABLE_NAME = 'sensor_readings';
        
        // ==================== å…¨å±€å˜é‡ ====================
        let sensorChart = null;
        let chartData = {
            labels: [],
            temperatures: [],
            humidities: [],
            pm25s: []
        };
        
        let autoRefresh = true;
        let autoRefreshInterval = null;
        let maxDataPoints = 50; // æœ€å¤šæ˜¾ç¤º50ä¸ªæ•°æ®ç‚¹ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        
        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–å›¾è¡¨
            initChart();
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('refreshBtn').addEventListener('click', fetchLatestData);
            document.getElementById('autoRefreshBtn').addEventListener('click', toggleAutoRefresh);
            document.getElementById('clearChartBtn').addEventListener('click', clearChart);
            
            // å¼€å§‹è·å–æ•°æ®
            fetchLatestData();
            setupAutoRefresh();
        });
        
        // ==================== æ ¸å¿ƒå‡½æ•° ====================
        function initChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'æ¸©åº¦ (Â°C)',
                            data: chartData.temperatures,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'æ¹¿åº¦ (%)',
                            data: chartData.humidities,
                            borderColor: '#4d96ff',
                            backgroundColor: 'rgba(77, 150, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'PM2.5',
                            data: chartData.pm25s,
                            borderColor: '#6bcf7f',
                            backgroundColor: 'rgba(107, 207, 127, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            padding: 12,
                            cornerRadius: 6
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    animation: {
                        duration: 750
                    }
                }
            });
        }
        
        async function fetchLatestData() {
            try {
                updateStatus('æ­£åœ¨è·å–æ•°æ®...', 'connecting');
                
                // è·å–æœ€æ–°çš„ä¸€æ¡æ•°æ®
                const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?device_id=eq.esp32_01&order=created_at.desc&limit=1`;
                
                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.length > 0) {
                    const sensorData = data[0];
                    updateDisplay(sensorData);
                    addToChart(sensorData);
                    updateStatus('è¿æ¥æ­£å¸¸', 'connected');
                    
                    // æ›´æ–°æ•°æ®è®¡æ•°
                    document.getElementById('dataCount').textContent = chartData.labels.length;
                } else {
                    updateStatus('æš‚æ— æ•°æ®', 'connecting');
                }
                
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                updateStatus(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function updateDisplay(data) {
            // æ ¼å¼åŒ–æ—¶é—´
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            // æ›´æ–°æ¸©åº¦
            document.querySelector('.temp .sensor-value').innerHTML = 
                `${data.temperature.toFixed(1)}<span class="sensor-unit">Â°C</span>`;
            document.querySelector('.time-temp').textContent = timeString;
            
            // æ›´æ–°æ¹¿åº¦
            document.querySelector('.humi .sensor-value').innerHTML = 
                `${data.humidity.toFixed(1)}<span class="sensor-unit">%</span>`;
            document.querySelector('.time-humi').textContent = timeString;
            
            // æ›´æ–°PM2.5
            document.querySelector('.pm25 .sensor-value').innerHTML = 
                `${data.pm25}<span class="sensor-unit">Î¼g/mÂ³</span>`;
            document.querySelector('.time-pm25').textContent = timeString;
            
            // æ›´æ–°ç©ºæ°”è´¨é‡
            const quality = getAirQuality(data.pm25);
            document.querySelector('.quality-text').textContent = quality.text;
            document.querySelector('.quality-text').className = `quality-${quality.level}`;
            
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            document.getElementById('lastUpdateTime').textContent = 
                now.toLocaleString('zh-CN', { 
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
        }
        
        function addToChart(data) {
            const timeLabel = new Date(data.created_at).toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // æ·»åŠ æ–°æ•°æ®
            chartData.labels.push(timeLabel);
            chartData.temperatures.push(data.temperature);
            chartData.humidities.push(data.humidity);
            chartData.pm25s.push(data.pm25);
            
            // é™åˆ¶æ•°æ®ç‚¹æ•°é‡ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            if (chartData.labels.length > maxDataPoints) {
                chartData.labels.shift();
                chartData.temperatures.shift();
                chartData.humidities.shift();
                chartData.pm25s.shift();
            }
            
            // æ›´æ–°å›¾è¡¨
            if (sensorChart) {
                sensorChart.data.labels = chartData.labels;
                sensorChart.data.datasets[0].data = chartData.temperatures;
                sensorChart.data.datasets[1].data = chartData.humidities;
                sensorChart.data.datasets[2].data = chartData.pm25s;
                sensorChart.update('quiet'); // ä½¿ç”¨quietæ¨¡å¼å‡å°‘æ€§èƒ½å¼€é”€
            }
        }
        
        function clearChart() {
            chartData = {
                labels: [],
                temperatures: [],
                humidities: [],
                pm25s: []
            };
            
            if (sensorChart) {
                sensorChart.data.labels = [];
                sensorChart.data.datasets[0].data = [];
                sensorChart.data.datasets[1].data = [];
                sensorChart.data.datasets[2].data = [];
                sensorChart.update();
            }
            
            document.getElementById('dataCount').textContent = '0';
            updateStatus('å›¾è¡¨å·²æ¸…ç©º', 'connected');
        }
        
        // ==================== è¾…åŠ©å‡½æ•° ====================
        function getAirQuality(pm25) {
            if (pm25 <= 35) return { text: 'ä¼˜', level: 'excellent' };
            if (pm25 <= 75) return { text: 'è‰¯', level: 'good' };
            if (pm25 <= 115) return { text: 'è½»åº¦æ±¡æŸ“', level: 'moderate' };
            if (pm25 <= 150) return { text: 'ä¸­åº¦æ±¡æŸ“', level: 'poor' };
            if (pm25 <= 250) return { text: 'é‡åº¦æ±¡æŸ“', level: 'very-poor' };
            return { text: 'ä¸¥é‡æ±¡æŸ“', level: 'hazardous' };
        }
        
        function updateStatus(message, type = 'connecting') {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function setupAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            if (autoRefresh) {
                autoRefreshInterval = setInterval(fetchLatestData, 10000); // 10ç§’åˆ·æ–°ä¸€æ¬¡
            }
        }
        
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const textEl = document.getElementById('autoRefreshText');
            
            if (autoRefresh) {
                textEl.textContent = 'å¼€å¯';
                setupAutoRefresh();
                updateStatus('è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯', 'connected');
            } else {
                textEl.textContent = 'å…³é—­';
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                updateStatus('è‡ªåŠ¨åˆ·æ–°å·²å…³é—­', 'connecting');
            }
        }
        
        // ==================== æ€§èƒ½ä¼˜åŒ– ====================
        // é¡µé¢å¯è§æ€§API - å½“é¡µé¢ä¸å¯è§æ—¶æš‚åœè‡ªåŠ¨åˆ·æ–°
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // é¡µé¢ä¸å¯è§ï¼Œä¿å­˜å½“å‰çŠ¶æ€
                window.wasAutoRefreshing = autoRefresh;
                if (autoRefresh) {
                    toggleAutoRefresh();
                }
            } else if (window.wasAutoRefreshing) {
                // é¡µé¢å†æ¬¡å¯è§ï¼Œæ¢å¤è‡ªåŠ¨åˆ·æ–°
                toggleAutoRefresh();
            }
        });
        
        // é˜²æ­¢å†…å­˜æ³„æ¼
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (sensorChart) {
                sensorChart.destroy();
            }
        });
    </script>
</body>
</html>
