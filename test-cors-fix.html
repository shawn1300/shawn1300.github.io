<!DOCTYPE html>
<html>
<head>
    <title>CORS修复测试</title>
</head>
<body>
    <h2>测试从 gezi.de5.net 访问API</h2>
    
    <div>
        <button onclick="testCORS()">测试CORS配置</button>
        <button onclick="testSubmit()">测试留言提交</button>
        <button onclick="openInNewTab()">在新标签页测试</button>
    </div>
    
    <pre id="result" style="background:#f5f5f5;padding:20px;margin-top:20px;"></pre>
    
    <script>
        const API_BASE = 'https://shawn1300-github-io.vercel.app/api';
        
        function log(msg) {
            document.getElementById('result').textContent += msg + '\n';
        }
        
        async function testCORS() {
            document.getElementById('result').textContent = '';
            log('当前页面地址: ' + window.location.origin);
            log('目标API地址: ' + API_BASE);
            log('--- 测试开始 ---\n');
            
            // 测试GET
            try {
                log('1. 测试GET请求...');
                const getRes = await fetch(API_BASE + '/get-comments');
                log(`  状态: ${getRes.status} ${getRes.statusText}`);
                const getData = await getRes.json();
                log(`  响应: ${JSON.stringify(getData.success)}`);
                log(`  留言数: ${getData.count}`);
            } catch (error) {
                log(`  GET错误: ${error.message}`);
            }
            
            // 测试OPTIONS
            try {
                log('\n2. 测试OPTIONS预检...');
                const optionsRes = await fetch(API_BASE + '/submit-comment', {
                    method: 'OPTIONS'
                });
                log(`  状态: ${optionsRes.status} ${optionsRes.statusText}`);
                log(`  Headers:`);
                optionsRes.headers.forEach((value, key) => {
                    if (key.toLowerCase().includes('access-control')) {
                        log(`    ${key}: ${value}`);
                    }
                });
            } catch (error) {
                log(`  OPTIONS错误: ${error.message}`);
            }
        }
        
        async function testSubmit() {
            log('\n3. 测试POST提交...');
            try {
                const response = await fetch(API_BASE + '/submit-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'CORS测试用户',
                        email: 'test@cors.com',
                        content: '这是一条测试留言，用于验证CORS修复'
                    })
                });
                
                log(`  状态码: ${response.status}`);
                log(`  状态文本: ${response.statusText}`);
                
                const data = await response.json();
                log(`  响应数据: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success) {
                    log('  ✅ CORS配置正确，提交成功！');
                } else {
                    log(`  ❌ 提交失败: ${data.error}`);
                }
            } catch (error) {
                log(`  ❌ 请求失败: ${error.message}`);
                log(`  完整错误: ${error}`);
            }
        }
        
        function openInNewTab() {
            window.open(window.location.href, '_blank');
        }
        
        // 页面加载时自动测试
        window.onload = testCORS;
    </script>
</body>
</html>
