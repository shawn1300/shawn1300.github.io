<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•™è¨€æ¿ | Shawn's Blog</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .form-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .messages-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
        }
        
        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .refresh-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .message-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .message-item {
            background: #f9f9f9;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .message-author {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .message-time {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .message-content {
            line-height: 1.6;
            color: #333;
        }
        
        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ ç•™è¨€æ¿</h1>
        <p class="subtitle">ç•™ä¸‹ä½ çš„æƒ³æ³•ï¼Œä¸å…¶ä»–è®¿å®¢äº¤æµ(ç”±äºç•™è¨€æ¿apié€šè¿‡vercel.comè·å–ï¼Œå¦‚æœæ‚¨æ— æ³•è®¿é—®vercel.comæˆ–å°†æ— æ³•åŠ è½½ç•™è¨€æ¿ğŸ˜­)</p>
        
        <!-- ç•™è¨€è¡¨å• -->
        <div class="form-box">
            <div class="input-group">
                <label for="name">æ˜µç§° *</label>
                <input type="text" id="name" placeholder="æ€ä¹ˆç§°å‘¼ä½ ï¼Ÿ" required>
            </div>
            
            <div class="input-group">
                <label for="email">é‚®ç®±ï¼ˆä»…åšä¸»å¯è§ï¼‰</label>
                <input type="email" id="email" placeholder="ä½ çš„é‚®ç®±ï¼ˆå¯é€‰ï¼‰">
            </div>
            
            <div class="input-group">
                <label for="message">ç•™è¨€å†…å®¹ *</label>
                <textarea id="message" placeholder="æƒ³è¯´çš„è¯..." required></textarea>
            </div>
            
            <div id="formStatus" class="status"></div>
            
            <button class="btn" id="submitBtn" onclick="submitMessage()">å‘å¸ƒç•™è¨€</button>
        </div>
        
        <!-- ç•™è¨€åˆ—è¡¨ -->
        <div class="messages-box">
            <div class="messages-header">
                <h2>ğŸ’¬ æœ€æ–°ç•™è¨€</h2>
                <button class="refresh-btn" onclick="loadMessages()">ğŸ”„ åˆ·æ–°</button>
            </div>
            
            <div id="loading" class="loading">æ­£åœ¨åŠ è½½ç•™è¨€...</div>
            <div id="messages" class="message-list"></div>
        </div>
        
        <div style="text-align:center; margin-top:20px; color:#666; font-size:14px;">
            ç•™è¨€å­˜å‚¨åœ¨ GitHub Issuesï¼Œåšä¸»å¯ä»¥åœ¨åå°ç®¡ç†
        </div>
    </div>

    <script>
        // ========== é…ç½® ==========
        const API = {
            GET: 'https://shawn1300-github-io.vercel.app/api/get-comments',
            POST: 'https://shawn1300-github-io.vercel.app/api/submit-comment'
        };
        
        // ========== é¡µé¢åŠ è½½ ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç•™è¨€æ¿åŠ è½½å®Œæˆ');
            loadMessages();
            
            // æ”¯æŒ Ctrl+Enter æäº¤
            document.getElementById('message').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    submitMessage();
                }
            });
        });
        
        // ========== åŠ è½½ç•™è¨€ ==========
        async function loadMessages() {
            const loading = document.getElementById('loading');
            const messagesDiv = document.getElementById('messages');
            
            loading.style.display = 'block';
            messagesDiv.innerHTML = '';
            
            try {
                console.log('æ­£åœ¨è·å–ç•™è¨€...');
                const response = await fetch(API.GET);
                const result = await response.json();
                
                console.log('è·å–ç»“æœ:', result);
                
                if (result.success) {
                    displayMessages(result.comments || []);
                } else {
                    throw new Error(result.error || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                messagesDiv.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // ========== æ˜¾ç¤ºç•™è¨€ ==========
function displayMessages(comments) {
    const messagesDiv = document.getElementById('messages');
    
    if (!comments || comments.length === 0) {
        messagesDiv.innerHTML = '<div class="empty">è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥ç¬¬ä¸€ä¸ªç•™è¨€å§ï¼</div>';
        return;
    }
    
    // æŒ‰æ—¶é—´å€’åº
    comments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    let html = '';
    comments.forEach(comment => {
        // ä»ç•™è¨€å†…å®¹æå–ä¿¡æ¯
        const body = comment.body || '';
        const username = extractUsername(body);
        const content = extractContent(body);
        const time = formatTime(comment.created_at); // ä½¿ç”¨GitHub APIçš„æ—¶é—´
        
        html += `
        <div class="message-item">
            <div class="message-header">
                <div class="message-author">ğŸ‘¤ ${escapeHtml(username || 'åŒ¿åç”¨æˆ·')}</div>
                <div class="message-time">${time}</div>
            </div>
            <div class="message-content">${escapeHtml(content || cleanContent(body))}</div>
        </div>
        `;
    });
    
    messagesDiv.innerHTML = html;
}
        
        // ========== æäº¤ç•™è¨€ ==========
        async function submitMessage() {
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const message = document.getElementById('message').value.trim();
            const statusDiv = document.getElementById('formStatus');
            const submitBtn = document.getElementById('submitBtn');
            
            // éªŒè¯
            if (!name || !message) {
                showStatus('è¯·å¡«å†™æ˜µç§°å’Œç•™è¨€å†…å®¹', 'error');
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';
            statusDiv.style.display = 'none';
            
            try {
                console.log('æ­£åœ¨æäº¤ç•™è¨€...', { name, email });
                
                const response = await fetch(API.POST, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: name,
                        email: email,
                        content: message
                    })
                });
                
                const result = await response.json();
                console.log('æäº¤ç»“æœ:', result);
                
                if (result.success) {
                    // æˆåŠŸ
                    showStatus('ç•™è¨€æäº¤æˆåŠŸï¼', 'success');
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('name').value = '';
                    document.getElementById('email').value = '';
                    document.getElementById('message').value = '';
                    
                    // é‡æ–°åŠ è½½ç•™è¨€
                    setTimeout(loadMessages, 1000);
                } else {
                    throw new Error(result.error || 'æäº¤å¤±è´¥');
                }
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                showStatus('æäº¤å¤±è´¥: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®
                submitBtn.disabled = false;
                submitBtn.textContent = 'å‘å¸ƒç•™è¨€';
            }
        }
        
        // ========== å·¥å…·å‡½æ•° ==========
        function extractUsername(body) {
            // æå– **ç”¨æˆ·å** æ ¼å¼
            const match = body.match(/\*\*(.*?)\*\*/);
            return match ? match[1] : null;
        }
        
        function extractContent(body) {
            // æå–ç•™è¨€æ­£æ–‡ï¼ˆå»æ‰ç”¨æˆ·åéƒ¨åˆ†ï¼‰
            const lines = body.split('\n');
            const contentStart = lines.findIndex(line => line.includes('ç•™è¨€ï¼š'));
            if (contentStart !== -1) {
                return lines.slice(contentStart + 1).join('\n').trim();
            }
            return body;
        }
        
function formatTime(timeString) {
    // ç¡®ä¿æœ‰æ—¶é—´å­—ç¬¦ä¸²
    if (!timeString) return 'æœªçŸ¥æ—¶é—´';
    
    try {
        const date = new Date(timeString);
        if (isNaN(date.getTime())) {
            return 'æ— æ•ˆæ—¶é—´';
        }
        
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        // è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
        const beijingOffset = 8 * 60 * 60 * 1000;
        const beijingTime = new Date(date.getTime() + beijingOffset);
        
        // æ ¼å¼åŒ–åŒ—äº¬æ—¶é—´
        const timeStr = beijingTime.toLocaleString('zh-CN', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        
        // ç›¸å¯¹æ—¶é—´ + ç»å¯¹æ—¶é—´
        if (minutes < 1) return 'åˆšåˆš';
        if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
        if (hours < 24) return `${hours}å°æ—¶å‰`;
        if (days < 30) return `${days}å¤©å‰`;
        
        // è¶…è¿‡30å¤©æ˜¾ç¤ºå®Œæ•´æ—¥æœŸ
        return beijingTime.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        }) + ' ' + timeStr.split(' ')[1];
        
    } catch (error) {
        console.error('æ—¶é—´æ ¼å¼åŒ–é”™è¯¯:', error);
        return timeString; // è¿”å›åŸå§‹å­—ç¬¦ä¸²
    }
}
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('formStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        // ========== å…¨å±€å¯¼å‡º ==========
        window.submitMessage = submitMessage;
        window.loadMessages = loadMessages;
        
        console.log('ç•™è¨€æ¿è„šæœ¬åˆå§‹åŒ–å®Œæˆ');
    </script>
</body>
</html>
